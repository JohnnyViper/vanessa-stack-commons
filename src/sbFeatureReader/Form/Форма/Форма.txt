
&НаКлиенте
Процедура Команда1(Команда)
	//ПрочитатьОписаниеФичиИРодительскиеКаталоги("D:\xDD\Rep\vanessa-stack-commons\lib\Проверка чтения описания и родительских каталогов фич", Истина, "");
	
	ПрочитатьОдинФайл("D:\xDD\Rep\vanessa-stack-commons\features\feature reader\Читатель фич умеет читать описание фич и их родительских каталогов.feature", Истина, "");
КонецПроцедуры

#Область Клиентские_API

#Область Фичи_и_родительские_каталоги

&НаКлиенте
Процедура НайтиИПрочитатьФайлыВКаталогах() Экспорт

КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОдинФайл(НачальноеИмяФайла, ИнвертироватьСтрокуРодительскихКаталогов, ИмяСобытия) Экспорт
	Фича = СоздатьФичу(Новый Файл(НачальноеИмяФайла));

	ДополнительныеПараметры = Новый Структура;
	
	ДополнительныеПараметры.Вставить("Фича", Фича);
	ДополнительныеПараметры.Вставить("ИмяСобытия", ИмяСобытия);
	ДополнительныеПараметры.Вставить("СледующаяПроцедура", Новый ОписаниеОповещения("ПрочитатьОдинФайлЗавершение", ЭтотОбъект));

	Адрес = "";
  
	НачатьПомещениеФайла(Новый ОписаниеОповещения("НачатьПомещениеФайлаЗавершение", ЭтотОбъект, ДополнительныеПараметры), Адрес, НачальноеИмяФайла, Ложь);
КонецПроцедуры

&НаКлиенте
Процедура НачатьПомещениеФайлаЗавершение(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	Если Не Результат Тогда
		Возврат;
	КонецЕсли;
	
	ПрочитатьОдинФайлНаСервере(ДополнительныеПараметры.Фича, Адрес);
	
	ВыполнитьОбработкуОповещения(ДополнительныеПараметры.СледующаяПроцедура, ДополнительныеПараметры.Фича); 
КонецПроцедуры

&НаСервере
Процедура ПрочитатьОдинФайлНаСервере(Фича, Адрес)
	Фича.Вставить("Функционал");

КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОдинФайлЗавершение(Фича, ДополнительныеПараметры) Экспорт
	Объект.Фичи = Новый Структура;
	
	ИмяПеременной = ПолучитьИмяПеременнойИзСтроки(Фича.ИмяБезРасширения);
	
	Объект.Фичи.Вставить(ИмяПеременной, Фича);
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОписаниеФичиИРодительскиеКаталоги(КаталогФич, ИнвертироватьСтрокуРодительскихКаталогов, ИмяСобытия) Экспорт
	Объект.Фичи = Новый Структура;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("КаталогПоиска", КаталогФич + "\");
	ДополнительныеПараметры.Вставить("ИнвертироватьСтрокуРодительскихКаталогов", ИнвертироватьСтрокуРодительскихКаталогов);
	ДополнительныеПараметры.Вставить("ИмяСобытия", ИмяСобытия);
	
	НачатьПоискФайлов(Новый ОписаниеОповещения("ПрочитатьОписаниеФичиИРодительскиеКаталогиЗавершение", ЭтотОбъект, ДополнительныеПараметры), КаталогФич, "*.feature", Истина);
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОписаниеФичиИРодительскиеКаталогиЗавершение(НайденныеФайлы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(НайденныеФайлы) Тогда
		Для Каждого НайденныйФайл Из НайденныеФайлы Цикл
			Фича = СоздатьФичу(НайденныйФайл);
			ОпределитьРодительскиеКаталогиФичи(Фича, НайденныйФайл, ДополнительныеПараметры);
			
			Объект.Фичи.Вставить(НайденныйФайл.ИмяБезРасширения, Фича);
		КонецЦикла;

		Оповестить(ДополнительныеПараметры.ИмяСобытия, Объект.Фичи);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Функция СоздатьФичу(НайденныйФайл)
	Фича = Новый Структура;
	
	Фича.Вставить("Имя", НайденныйФайл.Имя);
	Фича.Вставить("ИмяБезРасширения", НайденныйФайл.ИмяБезРасширения);
	Фича.Вставить("ПолноеИмя", НайденныйФайл.ПолноеИмя);
	Фича.Вставить("Путь", НайденныйФайл.Путь);
	Фича.Вставить("Расширение", НайденныйФайл.Расширение);
	Фича.Вставить("Родитель", Неопределено);
	
	Возврат Фича;
КонецФункции

&НаКлиенте
Процедура ОпределитьРодительскиеКаталогиФичи(Фича, НайденныйФайл, ДополнительныеПараметры)
	РодительскиеКаталоги = ПолучитьРодительскиеКаталоги(НайденныйФайл, ДополнительныеПараметры);
	
	СоздатьРодительскиеКаталоги(Фича.Родитель, РодительскиеКаталоги);
КонецПроцедуры

&НаКлиенте
Функция ПолучитьРодительскиеКаталоги(НайденныйФайл, ДополнительныеПараметры)
	СтрокаРодительскихКаталогов = СтрЗаменить(НайденныйФайл.Путь, ДополнительныеПараметры.КаталогПоиска, "");

	Если ДополнительныеПараметры.ИнвертироватьСтрокуРодительскихКаталогов Тогда
		ИнвертироватьСтрокуРодительскихКаталогов(СтрокаРодительскихКаталогов);	
	КонецЕсли;

	Разделитель = "\";
	
	РодительскиеКаталоги = Новый Массив;
	
	Пока Не ПустаяСтрока(СтрокаРодительскихКаталогов) Цикл
		ПозицияРазделителя = СтрНайти(СтрокаРодительскихКаталогов, Разделитель);
		Если ПозицияРазделителя = 0 Тогда
			СтрокаРодительскихКаталогов = "";
		Иначе
			Родитель = Лев(СтрокаРодительскихКаталогов, ПозицияРазделителя - 1);
			
			РодительскиеКаталоги.Вставить(0, Родитель);
			
			СтрокаРодительскихКаталогов = Сред(СтрокаРодительскихКаталогов, ПозицияРазделителя + 1);
		КонецЕсли;
	КонецЦикла;
	
	Возврат РодительскиеКаталоги;
КонецФункции

&НаСервере
Процедура ИнвертироватьСтрокуРодительскихКаталогов(ИсходнаяСтрока)
	Каталоги = Новый ТаблицаЗначений;
	
	Каталоги.Колонки.Добавить("Порядок");
	Каталоги.Колонки.Добавить("Каталог");
	
	Разделитель = "\";
	
	Индекс = 1;
	
	Пока Не ПустаяСтрока(ИсходнаяСтрока) Цикл
		НоваяСтрока = Каталоги.Добавить();
		
		НоваяСтрока.Порядок = Индекс;
		НоваяСтрока.Каталог = Лев(ИсходнаяСтрока, СтрНайти(ИсходнаяСтрока, Разделитель) - 1);
		
		ИсходнаяСтрока = Сред(ИсходнаяСтрока, СтрНайти(ИсходнаяСтрока, Разделитель) + 1);
		
		Индекс = Индекс + 1;
		
	КонецЦикла;

	Каталоги.Сортировать("Порядок Убыв");
	
	Для Каждого Строка Из Каталоги Цикл
		ИсходнаяСтрока = ИсходнаяСтрока + Строка.Каталог + Разделитель;

	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура СоздатьРодительскиеКаталоги(Родитель, РодительскиеКаталоги)
	Если Не ЗначениеЗаполнено(РодительскиеКаталоги) Тогда
		Возврат;
	КонецЕсли;
	
	ОписаниеРодителя = Новый Структура;
	
	ОписаниеРодителя.Вставить("Имя", РодительскиеКаталоги[0]);
	ОписаниеРодителя.Вставить("Родитель", Неопределено);

	Родитель = ОписаниеРодителя;
	
	РодительскиеКаталоги.Удалить(0);
	
	СоздатьРодительскиеКаталоги(Родитель.Родитель, РодительскиеКаталоги);
КонецПроцедуры

#КонецОбласти

#Область Фичи_и_заголовки

&НаКлиенте
Процедура ПрочитатьФичиИЗаголовки(КаталогФич)
	Фича = Новый ТекстовыйДокумент;

	

КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Серверные_API

#Область Содержание_фич

#КонецОбласти

#КонецОбласти


&НаКлиенте
Функция ПолучитьИмяПеременнойИзСтроки(ИсходнаяСтрока)
	ПроверочнаяСтрока = ПолучитьПроверочнуюСтроку();
	
	ИсходнаяСтрока = СокрЛП(ИсходнаяСтрока);
	ИтоговаяСтрока = "";
	
	Пробел = " ";
	НижнееПодчеркивание = "_";
	
	КрайнийСимвол = Истина;
	
	ДлинаСтроки = СтрДлина(ИсходнаяСтрока);
	Для Счетчик = 1 По ДлинаСтроки Цикл
		ТекущийСимвол = Сред(ИсходнаяСтрока, Счетчик, 1);
		
		Если Истина
			И ТекущийСимвол = Пробел
			И Не КрайнийСимвол = НижнееПодчеркивание
			Тогда
			
			ИтоговаяСтрока = ИтоговаяСтрока + "_";

		Иначе
			Если Найти(ПроверочнаяСтрока, ТекущийСимвол) > 0 Тогда
				ИтоговаяСтрока = ИтоговаяСтрока + ТекущийСимвол;

			КонецЕсли;
		КонецЕсли;
		
		КрайнийСимвол = Прав(ИтоговаяСтрока, 1);
	КонецЦикла;
	
	ПервыйСимвол = Лев(ИтоговаяСтрока, 1);
	Если Найти("0123456789", ПервыйСимвол) > 0 Тогда
		ИтоговаяСтрока = НижнееПодчеркивание + ИтоговаяСтрока;
	КонецЕсли;
	
	Возврат ИтоговаяСтрока;
КонецФункции

&НаСервере
Функция ПолучитьПроверочнуюСтроку()
	КириллицаЗаглавные = "АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ";
	КириллицаСтрочные = НРег(КириллицаЗаглавные);
	
	ЛатиницаЗаглавные = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
	ЛатиницаСтрочные = НРег(ЛатиницаЗаглавные);
	
	Цифры = "0123456789";
	
	ПроверочнаяСтрока = 
	КириллицаЗаглавные +
	КириллицаСтрочные +
	ЛатиницаЗаглавные +
	ЛатиницаСтрочные +
	Цифры;
	
	Возврат ПроверочнаяСтрока;
КонецФункции


&НаКлиенте
Процедура Маякнуть(Строка)
	ф = Новый ТекстовыйДокумент;
	ф.Записать("C:\" + Строка + ".txt");
КонецПроцедуры
