
&НаКлиенте
Процедура Команда1(Команда)
	ПрочитатьОписаниеФичиИРодительскиеКаталоги("D:\xDD\Rep\vanessa-stack-commons\lib\Проверка чтения описания и родительских каталогов фич", Истина, "");
КонецПроцедуры

#Область Клиентские_API

#Область Фичи_и_родительские_каталоги

&НаКлиенте
Процедура НайтиИПрочитатьФайлыВКаталогах() Экспорт

КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОдинФайл(НачальноеИмяФайла) Экспорт
	Адрес = "";

	НачатьПомещениеФайла(Новый ОписаниеОповещения("ПрочитатьОдинФайлЗавершение", ЭтотОбъект), Адрес, НачальноеИмяФайла,, УникальныйИдентификатор);
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОдинФайлЗавершение(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	Если Не Результат Тогда
		Возврат;
	КонецЕсли;
	
	ПрочитатьОдинФайлНаСервере(Адрес)
КонецПроцедуры

&НаСервере
Процедура ПрочитатьОдинФайлНаСервере(Адрес) 

КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОписаниеФичиИРодительскиеКаталоги(КаталогФич, ИнвертироватьСтрокуРодительскихКаталогов, ИмяСобытия) Экспорт
	Объект.Фичи = Новый Структура;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("КаталогПоиска", КаталогФич + "\");
	ДополнительныеПараметры.Вставить("ИнвертироватьСтрокуРодительскихКаталогов", ИнвертироватьСтрокуРодительскихКаталогов);
	ДополнительныеПараметры.Вставить("ИмяСобытия", ИмяСобытия);
	
	НачатьПоискФайлов(Новый ОписаниеОповещения("ПрочитатьОписаниеФичиИРодительскиеКаталогиЗавершение", ЭтотОбъект, ДополнительныеПараметры), КаталогФич, "*.feature", Истина);
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьОписаниеФичиИРодительскиеКаталогиЗавершение(НайденныеФайлы, ДополнительныеПараметры) Экспорт
	Если ЗначениеЗаполнено(НайденныеФайлы) Тогда
		Для Каждого НайденныйФайл Из НайденныеФайлы Цикл
			Фича = СоздатьФичу(Объект.Фичи, НайденныйФайл);
			ОпределитьРодительскиеКаталогиФичи(Фича, НайденныйФайл, ДополнительныеПараметры);
			
			Объект.Фичи.Вставить(НайденныйФайл.ИмяБезРасширения, Фича);
		КонецЦикла;

		Оповестить(ДополнительныеПараметры.ИмяСобытия, Объект.Фичи);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Функция СоздатьФичу(Фичи, НайденныйФайл)
	Фича = Новый Структура;
	
	Фича.Вставить("Имя", НайденныйФайл.Имя);
	Фича.Вставить("ИмяБезРасширения", НайденныйФайл.ИмяБезРасширения);
	Фича.Вставить("ПолноеИмя", НайденныйФайл.ПолноеИмя);
	Фича.Вставить("Путь", НайденныйФайл.Путь);
	Фича.Вставить("Расширение", НайденныйФайл.Расширение);
	Фича.Вставить("Родитель", Неопределено);
	
	Возврат Фича;
КонецФункции

&НаКлиенте
Процедура ОпределитьРодительскиеКаталогиФичи(Фича, НайденныйФайл, ДополнительныеПараметры)
	РодительскиеКаталоги = ПолучитьРодительскиеКаталоги(НайденныйФайл, ДополнительныеПараметры);
	
	СоздатьРодительскиеКаталоги(Фича.Родитель, РодительскиеКаталоги);
КонецПроцедуры

&НаКлиенте
Функция ПолучитьРодительскиеКаталоги(НайденныйФайл, ДополнительныеПараметры)
	СтрокаРодительскихКаталогов = СтрЗаменить(НайденныйФайл.Путь, ДополнительныеПараметры.КаталогПоиска, "");

	Если ДополнительныеПараметры.ИнвертироватьСтрокуРодительскихКаталогов Тогда
		ИнвертироватьСтрокуРодительскихКаталогов(СтрокаРодительскихКаталогов);	
	КонецЕсли;

	Разделитель = "\";
	
	РодительскиеКаталоги = Новый Массив;
	
	Пока Не ПустаяСтрока(СтрокаРодительскихКаталогов) Цикл
		ПозицияРазделителя = СтрНайти(СтрокаРодительскихКаталогов, Разделитель);
		Если ПозицияРазделителя = 0 Тогда
			СтрокаРодительскихКаталогов = "";
		Иначе
			Родитель = Лев(СтрокаРодительскихКаталогов, ПозицияРазделителя - 1);
			
			РодительскиеКаталоги.Вставить(0, Родитель);
			
			СтрокаРодительскихКаталогов = Сред(СтрокаРодительскихКаталогов, ПозицияРазделителя + 1);
		КонецЕсли;
	КонецЦикла;
	
	Возврат РодительскиеКаталоги;
КонецФункции

&НаСервере
Процедура ИнвертироватьСтрокуРодительскихКаталогов(ИсходнаяСтрока)
	Каталоги = Новый ТаблицаЗначений;
	
	Каталоги.Колонки.Добавить("Порядок");
	Каталоги.Колонки.Добавить("Каталог");
	
	Разделитель = "\";
	
	Индекс = 1;
	
	Пока Не ПустаяСтрока(ИсходнаяСтрока) Цикл
		НоваяСтрока = Каталоги.Добавить();
		
		НоваяСтрока.Порядок = Индекс;
		НоваяСтрока.Каталог = Лев(ИсходнаяСтрока, СтрНайти(ИсходнаяСтрока, Разделитель) - 1);
		
		ИсходнаяСтрока = Сред(ИсходнаяСтрока, СтрНайти(ИсходнаяСтрока, Разделитель) + 1);
		
		Индекс = Индекс + 1;
		
	КонецЦикла;

	Каталоги.Сортировать("Порядок Убыв");
	
	Для Каждого Строка Из Каталоги Цикл
		ИсходнаяСтрока = ИсходнаяСтрока + Строка.Каталог + Разделитель;

	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура СоздатьРодительскиеКаталоги(Родитель, РодительскиеКаталоги)
	Если Не ЗначениеЗаполнено(РодительскиеКаталоги) Тогда
		Возврат;
	КонецЕсли;
	
	ОписаниеРодителя = Новый Структура;
	
	ОписаниеРодителя.Вставить("Имя", РодительскиеКаталоги[0]);
	ОписаниеРодителя.Вставить("Родитель", Неопределено);

	Родитель = ОписаниеРодителя;
	
	РодительскиеКаталоги.Удалить(0);
	
	СоздатьРодительскиеКаталоги(Родитель.Родитель, РодительскиеКаталоги);
КонецПроцедуры

#КонецОбласти

#Область Фичи_и_заголовки

&НаКлиенте
Процедура ПрочитатьФичиИЗаголовки(КаталогФич)
	Фича = Новый ТекстовыйДокумент;

	

КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область Серверные_API

#Область Содержание_фич

#КонецОбласти

#КонецОбласти

&НаКлиенте
Процедура Маякнуть(Строка)
	ф = Новый ТекстовыйДокумент;
	ф.Записать("C:\" + Строка + ".txt");
КонецПроцедуры
